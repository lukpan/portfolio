---
const { diagram } = Astro.props;
---

<div class="mermaid-container">
  <pre class="mermaid">{diagram}</pre>
</div>

<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
  
  // Initialize mermaid if not already done
  if (!window.mermaidInitialized) {
    window.mermaidInitialized = true;
    mermaid.initialize({ 
      startOnLoad: true, 
      theme: 'dark',
      themeVariables: {
        darkMode: true,
        background: '#1a2234',
        primaryColor: '#f59e0b',
        primaryTextColor: '#f9fafb',
        primaryBorderColor: '#f59e0b',
        secondaryColor: '#fbbf24',
        secondaryTextColor: '#d1d5db',
        tertiaryColor: '#111827',
        tertiaryTextColor: '#9ca3af',
        lineColor: 'rgba(255, 255, 255, 0.2)',
        textColor: '#d1d5db',
        mainBkg: '#1a2234',
        secondBkg: '#111827',
        border1: 'rgba(245, 158, 11, 0.3)',
        border2: 'rgba(251, 191, 36, 0.2)',
        arrowheadColor: '#f59e0b',
        fontFamily: 'Manrope, -apple-system, BlinkMacSystemFont, sans-serif',
        fontSize: '16px'
      },
      flowchart: {
        nodeSpacing: 50,
        rankSpacing: 60,
        curve: 'basis',
        padding: 20
      },
      gantt: {
        titleTopMargin: 25,
        barHeight: 30,
        barGap: 8,
        topPadding: 50,
        leftPadding: 100,
        gridLineStartPadding: 35,
        fontSize: 14,
        sectionFontSize: 14,
        numberSectionStyles: 4
      }
    });
  }

  // Modal setup
  const MODAL_ID = 'mermaid-modal';
  if (!document.getElementById(MODAL_ID)) {
    const modal = document.createElement('div');
    modal.id = MODAL_ID;
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
      opacity: 0;
      transition: opacity 0.3s ease;
    `;
    
    modal.innerHTML = `
      <div style="position: relative; width: 95%; height: 95%; display: flex; justify-content: center; align-items: center;">
        <button id="mermaid-modal-close" style="
          position: absolute;
          top: 20px;
          right: 20px;
          background: none;
          border: none;
          color: white;
          font-size: 2rem;
          cursor: pointer;
          z-index: 10001;
          padding: 10px;
          line-height: 1;
        ">&times;</button>
        <div id="mermaid-modal-content" style="width: 100%; height: 100%; overflow: auto; display: flex; justify-content: center; align-items: center;"></div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    const closeBtn = document.getElementById('mermaid-modal-close');
    const content = document.getElementById('mermaid-modal-content');
    
    const closeModal = () => {
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.display = 'none';
        content.innerHTML = '';
      }, 300);
    };
    
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal || e.target.parentElement === modal) {
        closeModal();
      }
    });
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.style.display === 'flex') {
        closeModal();
      }
    });
  }

  // Attach click handlers
  // We use a timeout to ensure mermaid has rendered the SVGs
  setTimeout(() => {
    document.querySelectorAll('.mermaid-container').forEach(container => {
      if (container.dataset.hasClickHandler) return;
      container.dataset.hasClickHandler = 'true';
      
      container.addEventListener('click', () => {
        const modal = document.getElementById(MODAL_ID);
        const content = document.getElementById('mermaid-modal-content');
        const svg = container.querySelector('svg');
        
        if (svg && modal && content) {
          const clonedSvg = svg.cloneNode(true);
          clonedSvg.style.maxWidth = '100%';
          clonedSvg.style.maxHeight = '100%';
          clonedSvg.style.height = 'auto';
          clonedSvg.style.width = 'auto';
          clonedSvg.removeAttribute('height');
          clonedSvg.removeAttribute('width');
          
          content.innerHTML = '';
          content.appendChild(clonedSvg);
          
          modal.style.display = 'flex';
          // Force reflow
          modal.offsetHeight;
          modal.style.opacity = '1';
        }
      });
    });
  }, 1000);
</script>

<style>
  .mermaid-container {
    background: var(--color-bg-elevated, #1a2234);
    border: 1px solid var(--color-border-medium, rgba(255, 255, 255, 0.1));
    border-radius: 0.75rem;
    padding: clamp(1.5rem, 4vw, 3rem);
    margin: 3rem 0;
    overflow-x: auto;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
    cursor: zoom-in;
    position: relative;
  }

  .mermaid-container::after {
    content: 'Click to expand';
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    opacity: 0;
    transition: opacity 0.2s;
    pointer-events: none;
  }
  
  .mermaid-container:hover::after {
    opacity: 1;
  }
  
  .mermaid-container::-webkit-scrollbar {
    height: 8px;
  }
  
  .mermaid-container::-webkit-scrollbar-track {
    background: var(--color-bg-secondary, #111827);
    border-radius: 4px;
  }
  
  .mermaid-container::-webkit-scrollbar-thumb {
    background: var(--color-accent-primary, #f59e0b);
    border-radius: 4px;
  }
  
  .mermaid-container::-webkit-scrollbar-thumb:hover {
    background: var(--color-accent-secondary, #fbbf24);
  }
  
  /* Ensure text is readable */
  .mermaid {
    display: flex;
    justify-content: center;
    min-height: 300px;
  }
  
  /* Give Gantt charts more space */
  .mermaid svg {
    max-width: 100%;
    height: auto;
    min-width: 800px;
  }
  
  /* Improve accessibility */
  @media (prefers-reduced-motion: reduce) {
    .mermaid * {
      animation: none !important;
      transition: none !important;
    }
  }
  
  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .mermaid-container {
      padding: 1rem;
      margin: 2rem -1rem;
      border-radius: 0;
      border-left: none;
      border-right: none;
    }
  }
</style>
