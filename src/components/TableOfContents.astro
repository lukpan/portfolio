---
// TableOfContents component - displays page heading hierarchy
// Automatically generated from MDX content headings
---

<nav class="toc-nav" aria-label="Table of Contents">
  <div class="toc-header">
    <h3 class="toc-title">On this page</h3>
  </div>
  <div class="toc-content">
    <!-- Content will be populated by client-side script -->
  </div>
</nav>

<script>
  // Generate table of contents from page headings
  function generateTableOfContents() {
    const tocNav = document.querySelector('.toc-nav');
    const tocContent = document.querySelector('.toc-content');
    if (!tocContent) return;

    // Find all h2 headings in the article
    const article = document.querySelector('.project-content');
    if (!article) return;

    const headings = article.querySelectorAll('h2');
    if (headings.length === 0) return;

    // Clear existing content
    tocContent.innerHTML = '';

    // Create list structure
    const ul = document.createElement('ul');
    ul.className = 'toc-list';

    headings.forEach((heading, index) => {
      // Generate ID if not present
      if (!heading.id) {
        heading.id = heading.textContent
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');
      }

      const li = document.createElement('li');
      li.className = `toc-item toc-${heading.tagName.toLowerCase()}`;

      const link = document.createElement('a');
      link.href = `#${heading.id}`;
      link.textContent = heading.textContent;
      link.className = 'toc-link';

      li.appendChild(link);
      ul.appendChild(li);
    });

    tocContent.appendChild(ul);

    // Add scroll spy functionality
    addScrollSpy(headings);
  }

  function addScrollSpy(headings) {
    const links = document.querySelectorAll('.toc-link');
    if (links.length === 0) return;

    // Set first item as active initially
    if (links[0]) {
      links[0].classList.add('active');
    }

    let activeHeading = null;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const id = entry.target.getAttribute('id');
          const link = document.querySelector(`.toc-link[href="#${id}"]`);

          if (entry.isIntersecting) {
            activeHeading = entry.target;
            // Remove active class from all links
            links.forEach((l) => l.classList.remove('active'));
            // Add active class to current link
            if (link) {
              link.classList.add('active');
            }
          }
        });
      },
      {
        rootMargin: '-20% 0px -70% 0px',
        threshold: [0, 0.25, 0.5, 0.75, 1]
      }
    );

    headings.forEach((heading) => {
      observer.observe(heading);
    });

    // Also update on scroll as a fallback
    let ticking = false;
    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateActiveLink();
          ticking = false;
        });
        ticking = true;
      }
    });

    function updateActiveLink() {
      const scrollPosition = window.scrollY + 150;
      
      let current = null;
      headings.forEach((heading) => {
        const top = heading.offsetTop;
        if (scrollPosition >= top) {
          current = heading;
        }
      });

      if (current && current !== activeHeading) {
        const id = current.getAttribute('id');
        const link = document.querySelector(`.toc-link[href="#${id}"]`);
        if (link) {
          links.forEach((l) => l.classList.remove('active'));
          link.classList.add('active');
          activeHeading = current;
        }
      }
    }
  }

  // Smooth scroll behavior
  function initSmoothScroll() {
    document.querySelectorAll('.toc-link').forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href').substring(1);
        const target = document.getElementById(targetId);

        if (target) {
          const yOffset = -100; // Offset for fixed header
          const y = target.getBoundingClientRect().top + window.pageYOffset + yOffset;

          window.scrollTo({ top: y, behavior: 'smooth' });
        }
      });
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    generateTableOfContents();
    initSmoothScroll();
  });

  // Re-initialize on astro page transitions
  document.addEventListener('astro:page-load', () => {
    generateTableOfContents();
    initSmoothScroll();
  });
</script>

<style is:global>
  .toc-nav {
    position: sticky;
    top: 6rem;
    max-height: calc(100vh - 8rem);
    overflow-y: auto;
    padding: 1.5rem;
    background-color: var(--color-bg-elevated);
    border: 1px solid var(--color-border-medium);
    border-radius: 0.75rem;
    margin-bottom: 2rem;
  }

  .toc-header {
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--color-border-subtle);
  }

  .toc-title {
    font-family: var(--font-display);
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-accent-primary);
    margin: 0;
  }

  .toc-content {
    font-size: 0.875rem;
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    margin: 0;
  }

  .toc-h2 {
    margin-top: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .toc-link {
    display: block;
    padding: 0.5rem 0.75rem;
    color: var(--color-text-tertiary);
    text-decoration: none;
    border-left: 2px solid transparent;
    margin-left: -0.75rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    line-height: 1.4;
    position: relative;
    border-radius: 0.375rem;
  }

  .toc-link::before {
    content: '';
    position: absolute;
    left: 0.5rem;
    top: 50%;
    transform: translateY(-50%) scale(0);
    width: 4px;
    height: 4px;
    background: var(--color-accent-primary);
    border-radius: 50%;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .toc-link:hover {
    color: var(--color-accent-primary);
    background: linear-gradient(90deg, var(--color-bg-hover) 0%, transparent 100%);
    border-left-color: var(--color-accent-primary);
    transform: translateX(2px);
  }

  .toc-link:hover::before {
    transform: translateY(-50%) scale(1);
  }

  .toc-link.active {
    color: var(--color-accent-primary);
    font-weight: 600;
    border-left-color: var(--color-accent-primary);
    background: linear-gradient(90deg, rgba(139, 92, 246, 0.08) 0%, transparent 100%);
  }

  .toc-link.active::before {
    transform: translateY(-50%) scale(1);
    animation: glow 2s ease-in-out infinite;
  }

  @keyframes glow {
    0%, 100% {
      opacity: 1;
      box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4);
    }
    50% {
      opacity: 0.8;
      box-shadow: 0 0 6px 2px rgba(139, 92, 246, 0.3);
    }
  }

  /* Smooth scrollbar styling */
  .toc-nav::-webkit-scrollbar {
    width: 6px;
  }

  .toc-nav::-webkit-scrollbar-track {
    background: transparent;
  }

  .toc-nav::-webkit-scrollbar-thumb {
    background: var(--color-border-medium);
    border-radius: 3px;
  }

  .toc-nav::-webkit-scrollbar-thumb:hover {
    background: var(--color-accent-primary);
  }

  /* Hide on smaller screens */
  @media (max-width: 1280px) {
    .toc-nav {
      display: none;
    }
  }
</style>
